# ã‚ªãƒˆãƒŠã®Pythonå…¥é–€#Discord_Botç·¨
2019å¹´5æœˆ22æ—¥

ã‚ªãƒˆãƒŠã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å‹‰å¼·ä¼š<br>
å”åŠ› **æœªæ¥ä¼šè­°å®¤**

[connpass](https://otona.connpass.com)<!--- .element target="_blank" rel="noopener" -->

---

# è‡ªå·±ç´¹ä»‹

- æ‘ä¸Šã€€å“
- ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹
- Angular/Ruby On Rails

---

ã‚ªãƒˆãƒŠã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å‹‰å¼·ä¼š<br>
[http://otona.pro](http://otona.pro)<!--- .element target="_blank" rel="noopener" -->

- 2016å¹´8æœˆã‹ã‚‰é–‹å§‹
- æœˆ2å›ï¼ˆç¬¬1æ°´æ›œã€ç¬¬3æ°´æ›œï¼‰
- ã„ã¤ã§ã‚‚è¬›å¸«å‹Ÿé›†ä¸­
    - ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨€èªã€æ©Ÿæ¢°å­¦ç¿’ã€Webç³»...
- [YouTube Live](https://www.youtube.com/channel/UCrXf76sF5RUKcGpMpZASqow)<!--- .element target="_blank" rel="noopener" -->ã§ãƒªãƒ¢ãƒ¼ãƒˆå‚åŠ ã‚‚æŒ¯ã‚Šè¿”ã‚Šã‚‚å¯(?)

---

# Discord Botã‚’ä½œã‚ã†

---

# Discord

- ã‚²ãƒ¼ãƒãƒ¼å‘ã‘ãƒœã‚¤ã‚¹ï¼†ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒƒãƒˆ
- è‡ªåˆ†ã§ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã¦ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä½œæˆ
- Steamãªã©ã®ã‚²ãƒ¼ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®é€£æºãŒã™ã”ã„
- Slackã¨ã‹Skypeã¨ã‹MSN(Live)ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ã¿ãŸã„ãªã®

---

# BOT

- äººé–“ã«å¤‰ã‚ã£ã¦ä½œæ¥­ã‚’ã—ã¦ãã‚Œã‚‹ãƒ­ãƒœãƒƒãƒˆ
- Discordã§ã¯BOTãƒ¦ãƒ¼ã‚¶ã¨ã—ã¦å‚åŠ 
- BOTæ©Ÿèƒ½ã‚’è‡ªåˆ†ã§ã¤ãã‚ã†
  - æŒ¨æ‹¶
  - ãŠã¿ãã˜
  - ç°¡æ˜“é›»å“

---

# å‰æº–å‚™

è‡ªåˆ†ã®ã‚µãƒ¼ãƒã‚’ä½œæˆã—ã‚ˆã†

- Discordã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
- ã‚µãƒ¼ãƒã‚’è¿½åŠ 


---

# å‰æº–å‚™#1

![pre01](../../image/20190522/pre01.png)

---

# å‰æº–å‚™#2

![pre02](../../image/20190522/pre02.png)

---

# å‰æº–å‚™#3

ä»»æ„ã®ã‚µãƒ¼ãƒåã‚’å…¥åŠ›

![pre03](../../image/20190522/pre03.png)

---

# é–‹ç™ºç’°å¢ƒ#1

- Python 3.5.3ä»¥é™

Pythonå®Ÿè¡Œç’°å¢ƒãŒãªã„æ–¹ã¯ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹  
[https://coder.otona.pro](https://coder.otona.pro)<!--- .element target="_blank" rel="noopener" -->


---

# é–‹ç™ºç’°å¢ƒ#2

discord.pyã‚’pipã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰(coderã®æ–¹ã¯å¿…è¦ãªã—)

```console
# Mac or Linux
$ python3 -m pip install -U discord.py

# Windows
$ py -3 -m pip install -U discord.py
```

[https://discordpy.readthedocs.io/ja/latest/](https://discordpy.readthedocs.io/ja/latest/)<!--- .element target="_blank" rel="noopener" -->

---

# ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ(coder)

ä»–ã®æ–¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¢«ã‚‰ãªã„ã‚ˆã†ã«è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ  
[Terminal] -> [New Terminal]

```console
$ mkdir [YOUR_ID]
$ cd [YOUR_ID]
```

---

# ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```
$ touch bot.py
```

---

# é››å½¢

```python
# bot.py
import discord
# ã‚ã¨ã§å–å¾—ã—ãŸã‚‚ã®ã‚’â†“ã¨å·®ã—æ›¿ãˆã¦ãã ã•ã„
TOKEN = 'YOUR_ACCESS_TOKEN'

client = discord.Client()

@client.event
async def on_ready():
    print("ready call!")

@client.event
async def on_message(message):
    if message.author.bot:
        return
    if message.content == '/neko':
        await message.channel.send('ã«ã‚ƒãƒ¼')

client.run(TOKEN)
```

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#1

ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹

[https://discordapp.com/developers/applications/](https://discordapp.com/developers/applications/)<!--- .element target="_blank" rel="noopener" -->

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#2
![01](../../image/20190522/01.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#3
![02](../../image/20190522/02.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#4
![03](../../image/20190522/03.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#5
![04](../../image/20190522/04.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#6
![05](../../image/20190522/05.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#7
![06](../../image/20190522/06.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#8
![07](../../image/20190522/07.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#9
![08](../../image/20190522/08.png)

---

# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³#10
![09](../../image/20190522/09.png)

---

# BOTå®Ÿè¡Œ

```console
$ cd [YOUR_ID]
$ python3 bot.py 
ready call!

# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¾…ã¡
# Ctrl+cã§çµ‚äº†
```

---

# ãƒ†ã‚¹ãƒˆ

![test01](../../image/20190522/test01.png)

---

# BOTãŒã§ããŸï¼

---

# æ§‹æ–‡è§£èª¬

`@client.event`ã¨ã‹`async/await`ã£ã¦ä½•ï¼Ÿ

---

# ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿#1

`@client.event`ã®ã‚ˆã†ã«@ã‹ã‚‰å§‹ã¾ã‚‹è£…é£¾ã‚’`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿`ã¨å‘¼ã¶
Pythonã§ã¯ä»¥ä¸‹ã®ç¨®é¡ã‚’ã‚µãƒãƒ¼ãƒˆ

- é–¢æ•°
- ãƒ¡ã‚½ãƒƒãƒ‰
- ã‚¯ãƒ©ã‚¹

---

# ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿#2

ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚·ãƒ¥ã‚¬ãƒ¼  
ä»¥ä¸‹ã®2ã¤ã®ã‚³ãƒ¼ãƒ‰ã¯ã»ã¼åŒã˜æ„å‘³

```
@f1(arg)
@f2
def func(): pass
```

```
def func(): pass # é•ã„ã¯ã“ã“ã§funcãŒä¸€åº¦å®šç¾©ã•ã‚Œã‚‹
func = f1(arg)(f2(func))
```

å‚è€ƒ: [Python è¨€èªãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.python.org/ja/3/reference/compound_stmts.html#function)<!--- .element target="_blank" rel="noopener" -->

---

# ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿#3

å®Ÿè¡Œã‚µãƒ³ãƒ—ãƒ«

```python
# deco.py
def deco(func):
    def wrapper(*args, **kwargs):
        print('---start---')
        func(*args, **kwargs)
        print("---end---")
    return wrapper

@deco
def main():
    print('Hello Decorator')

if __name__ == "__main__":
    main()
```

å‚è€ƒ: [Pythonã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã¤ã„ã¦ - Qiita](https://qiita.com/mtb_beta/items/d257519b018b8cd0cc2e)<!--- .element target="_blank" rel="noopener" -->

---

# ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿#4

```console
$ python3 deco.py
---start---
Hello Decorator
---end---
```

---

# ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿#5

discord.pyã®ã‚½ãƒ¼ã‚¹ã‚’ç¢ºèª  
@client.eventã§æ¸¡ã—ãŸé–¢æ•°ã‚’discord.pyã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ   

```python
class Client:
    # çœç•¥
    # ã‚³ãƒ¡ãƒ³ãƒˆçœç•¥
    def event(self, coro):
        if not asyncio.iscoroutinefunction(coro):
            raise TypeError('event registered must be a coroutine function')
        # setattrã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã•ã‚Œã‚‹
        setattr(self, coro.__name__, coro)
        log.debug('%s has successfully been registered as an event', coro.__name__)
        return coro
```


å‚è€ƒ: [https://github.com/Rapptz/discord.py/blob/master/discord/client.py](https://github.com/Rapptz/discord.py/blob/master/discord/client.py)<!--- .element target="_blank" rel="noopener" -->


---

# async/await #1

ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’æ‰±ã†ãŸã‚ã®æ§‹æ–‡  
ã“ã“ã§ã¯ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚€ãŸã‚ã®è¡¨å±¤çš„ãªéƒ¨åˆ†ã®ã¿ç´¹ä»‹ã™ã‚‹  

---

# async/await #2

asyncã¨ä¸€ç·’ã«å®£è¨€ã‚’ã—ãŸé–¢æ•°ã¯ã‚³ãƒ«ãƒ¼ãƒãƒ³ã«ãªã‚‹  
é€šå¸¸ã®é–¢æ•°å‘¼ã³å‡ºã—ã§ã¯ã‚¨ãƒ©ãƒ¼

```python
import asyncio

async def hello_world():
    print("Hello World!")

# ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
loop = asyncio.get_event_loop()
# ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«å‘¼ã³å‡ºã—ã‚’ä»»ã›ã‚‹
loop.run_until_complete(hello_world())
loop.close()
```

å‚è€ƒ: [python3 ã® async/awaitã‚’ç†è§£ã™ã‚‹ - Qiita](https://qiita.com/maueki/items/8f1e190681682ea11c98)<!--- .element target="_blank" rel="noopener" -->

---

# async/await #3

awaitã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§asyncé–¢æ•°ã‚’å‘¼ã³å‡ºã›ã‚‹

```python
import asyncio

async def hello_world():
    print("Hello World!")

async def call_hello_world():
    await hello_world()

loop = asyncio.get_event_loop()
loop.run_until_complete(call_hello_world())
```

---

# async/await #4

ã‚‚ã†ä¸€åº¦discord.pyã®ã‚½ãƒ¼ã‚¹ã‚’ç¢ºèª  
ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’å—ã‘å–ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹

```python
class Client:
    # çœç•¥
    # ã‚³ãƒ¡ãƒ³ãƒˆçœç•¥
    def event(self, coro):
        if not asyncio.iscoroutinefunction(coro):
            raise TypeError('event registered must be a coroutine function')
        # setattrã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã•ã‚Œã‚‹
        setattr(self, coro.__name__, coro)
        log.debug('%s has successfully been registered as an event', coro.__name__)
        return coro
```

å‚è€ƒ: [https://github.com/Rapptz/discord.py/blob/master/discord/client.py](https://github.com/Rapptz/discord.py/blob/master/discord/client.py)<!--- .element target="_blank" rel="noopener" -->

---

# ä¼‘æ†©ï¼ˆè³ªç–‘å¿œç­”ï¼‰

---

# ãŠã¿ãã˜ã‚’ä½œã‚ã†#1

ç°¡å˜ãªãŠã¿ãã˜æ©Ÿèƒ½ã‚’å®Ÿè£…

- Randomæ©Ÿèƒ½ã‚’ä½¿ã£ã¦é‹å‹¢ã‚’è¡¨ç¤º
- Discordã®Embedè¡¨ç¤ºã‚’ä½¿ç”¨
- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦å¼•ãç›´ã—å¯èƒ½

---

# ãŠã¿ãã˜ã‚’ä½œã‚ã†#2

æœ€åˆã«ã‚·ãƒ³ãƒ—ãƒ«ãªãŠã¿ãã˜ã‚’å®Ÿè£…ã—ã¦ãƒ†ã‚¹ãƒˆ

```python
import random # èª­ã¿è¾¼ã¿è¿½åŠ 

# çœç•¥(on_messageå†…)
    if message.content == '/omikuji':
        value = omikuji(random.randint(0, 100))
        await message.channel.send(value)

def omikuji(num = 0):
    if num < 10:
        return "å¤§å‰"
    elif 10 <= num < 30:
        return "ä¸­å‰"
    elif 30 <= num < 60:
        return "å°å‰"
    elif 60 <= num < 80:
        return "å‰"
    elif 80 <= num < 95:
        return "æœ«å‰"
    else:
        return "å‡¶"
```

---

# ãŠã¿ãã˜ã‚’ä½œã‚ã†#3

åŸ‹ã‚è¾¼ã¿å½¢å¼ã«ã—ã‚ˆã†

```python
# çœç•¥(on_messageå†…)
    if message.content == '/omikuji':
        value = omikuji(random.randint(0, 100))
        await send_omikuji(message.channel, message.author, value)

async def send_omikuji(channel, user, value):
    embed = discord.Embed(title="ãŠã¿ãã˜",
                        description=f"{user.mention}ã•ã‚“ã®ä»Šæ—¥ã®é‹å‹¢ã¯ï¼",
                        color=discord.Colour.from_rgb(255,0,0))
    embed.set_thumbnail(url=user.avatar_url)
    embed.add_field(name="é‹å‹¢: ", value=value, inline=False)
    await channel.send(embed=embed)
```

---

# ãŠã¿ãã˜ã‚’ä½œã‚ã†#4

ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã‚ˆã†

```python
# ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã£ãŸå ´åˆã«å‘¼ã³å‡ºã—
@client.event
async def on_reaction_add(reaction, user):
    if (reaction.emoji == 'â­•'):
        value = omikuji(random.randint(0, 100))
        await send_omikuji(reaction.message.channel, user, value)

async def send_omikuji(channel, user, value):
    # çœç•¥
    embed.add_field(name="é‹å‹¢: ", value=value, inline=False)
    embed.add_field(name="ã‚‚ã†ä¸€åº¦?", value="â­•(:o:)ã‚’ã¤ã‘ã‚‹ã¨ã‚‚ã†ä¸€åº¦ãã˜ã‚’å¼•ãã¾ã™", inline=False)
    await channel.send(embed=embed)
```

---

# ä¼‘æ†©ï¼ˆè³ªç–‘å¿œç­”ï¼‰

---

# ç°¡æ˜“é›»å“#1

- evalã‚’ä½¿ã£ã¦ç°¡æ˜“é›»å“
- å…¬é–‹BOTã§ã“ã‚“ãªå®Ÿè£…ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“

ã‚ãã¾ã§æ©Ÿèƒ½ä¾‹ã¨ã—ã¦ãŠé¡˜ã„ã—ã¾ã™ğŸ™‡

---

# ç°¡æ˜“é›»å“#2

```python
import re
# æ­£è¦è¡¨ç¾ã§å¼•æ•°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®å®šç¾©
calc_pattern = re.compile('\A\/calc (.+)\Z')

# çœç•¥(on_messageå†…)
    result = calc_pattern.match(message.content)
    if result:
        exp = result.group(1)
        res = eval(exp) # å…¬é–‹BOTã§evalã‚’ä½¿ã‚ãªã„ã§ãã ã•ã„
        await message.channel.send(res)
```

---

# è³‡æ–™ã¯ã“ã“ã¾ã§

---

# è‡ªç”±æ™‚é–“

æ€ã„ã¤ãã¾ã¾ã«è§¦ã£ã¦ã¿ã¦ãã ã•ã„

- ä»–APIã¨é€£æº(å¤©æ°—äºˆå ±ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€Todo...)
- Discordã‚¤ãƒ™ãƒ³ãƒˆã®åˆ©ç”¨(å‚åŠ è€…è¿½åŠ ã€Botã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³...)
- æ—¢å­˜ã®Discordã‚„Slackã®Botã‚’å‚è€ƒã«

---

# BOTå…¬é–‹ã®ãŸã‚ã«

- BOTæ¨©é™ã‚’æœ€å°ã«ã™ã‚‹
    - ä»Šå›ã¯ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã€‚å…¬é–‹ã™ã‚‹å ´åˆã¯æ¨©é™ã‚’å¿…è¦ãªã‚‚ã®ã ã‘ã«
- Herokuã‚„GCPã®ç„¡æ–™æ ã‚’æ´»ç”¨ã—ã‚ˆã†

---

# è³‡æ–™

- [discord.pyã¸ã‚ˆã†ã“ãã€‚](https://discordpy.readthedocs.io/ja/latest/)<!--- .element target="_blank" rel="noopener" -->
- [Pythonã§å®Ÿç”¨Discord Bot(discordpyè§£èª¬) - Qiita](https://qiita.com/1ntegrale9/items/9d570ef8175cf178468f)<!--- .element target="_blank" rel="noopener" -->
- [Pythonã«ãŠã‘ã‚‹éåŒæœŸå‡¦ç†: asyncioé€†å¼•ããƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://qiita.com/icoxfog417/items/07cbf5110ca82629aca0)<!--- .element target="_blank" rel="noopener" -->

---

# ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸğŸµ
